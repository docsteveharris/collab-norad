---
title: "scratch_results"
author: "Steve Harris"
date:	"7 Mar 2016"
output: md_document
---

```{r setup, include=FALSE, echo=FALSE}
rm(list=ls(all=TRUE))
source(file="../prep/strobe.R")
source(file="../prep/prep_vars.R")
source(file="../share/functions4rmd.R")
```

# Abstract

# Introduction

# Methods

## Patients

- [ ] TODO(2016-03-17): concept of sequentially stricter subgroups

We requested data on one hundred consecutive admissions with septic shock from eight critical care units across Europe. Patients were eligible if they were treated for presumed infection, and required noradrenaline infusion for one hour or more, and survived for a minimum of 24 hours (else no treatment vars). We defined a subgroup of patients with resistant septic shock where the noradrenaline infusion was not weaned within 24 hours, and a tachycardic septic shock subgroup that mimicked the control group in the study by Morelli et al where the heart rate had to be greater than 95 beats/minute at 24 hours, and the patients had not received beta-blockers therapy.

## Definitions

- need to describe vasopressor and sedation scores
- classify high vs low map target at 24 hours
	- use 75 as per Asfar
- classify high vs low heart rate groups: split at [0,95) and [95,] as per Morelli
- define patient level predictors
	+ age
	+ sex
	+ weight
	+ sepsis site
	+ initial SOFA score (at hour 1)
- define treatment variables
	+ noradrenaline dose (weight adjusted) at 24h
	+ mean arterial pressure at 24h (treatment variable)
	+ fluid balance in 1st 24h
	+ mechanical ventilation
	+ renal replacement therapy
	+ other vasopressors (yes/no)
	+ other inotropes (yes/no) ? or just combine with above and calculate by subtracting from VADI
	+ sedatation dose

## Research questions

1. Report the proportion of patients meeting the criteria for resistant septic shock at 24hrs, and build a model to predict this using patient level characteristics but report ICC variant
2. Ditto for tachycardic septic shock
3. Now report treatment variation for noradrenaline using ICC (and other treatment variables)
	- table with overall (pooled) median and group level min/max median and ICC from model
4. Finally report mortality outcomes after adjusting for patient level variation
5. Given differences in noradrenaline use then look at how that interacts with patient and treatment outcomes

## Statistical analaysis	

We built multi-level models with random effects for the sites to quantify the effect of the patient level factors and treatment variables. Where the outcomes were continuous we used linear models (fluid balance, mean arterial pressure) with a log transform where the data were skewed (noradrenaline dose). Where the outcomes were binary (resistant septic shock, resistant septic shock with tachycardia, and mortality), we used generalised linear model with a logistic link. Since we were more interested in the relative importance of the predictors rather than their absolute effect, we standardised each after suitable transformation by subtracting the mean and dividing by twice the standard deviation to permit direct comparison of the relative importance of each predictor (Gelman).

We used the intraclass correlation (ICC) to summarise the proportion of the variation in each outcome that is derived via group membership (the random effects term). Low values imply that most variation is explained at the patient level, and high values imply that most variation is explained at the Intensive Care Unit level.

- [ ] TODO(2016-03-17): ICC for binary outcomes
	- [ ] add comment about how ICC works for such models
- [ ] TODO(2016-03-17): bootstrap CI for ICC?

Where we specifically investigated the effect of noradrenaline dose on mortality, we allowed its effect to vary between sites in a random intercept/random slope model, and included interactions between noradrenaline and high and low mean arterial pressures, high and low heart rates.


# Results
```{r strobe, include=FALSE, echo=FALSE}

(los.itu.0    <- ff.np(data=wdt.original, exclude.los.itu.0))
(include    <- ff.np(data=wdt.original, include))
(grp.ne24    <- ff.np(data=wdt, grp.ne24))
(rx.betablock <- ff.np(data=wdt.original, exclude.rx.betablock))
(grp.morelli    <- ff.np(data=wdt, grp.morelli))
(hosp.n       <- ff.mediqr(N, data=wdt[,.N,by=hosp]))
```

We reviewed

We screened `r nrow(wdt.original)` consecutive admissions with septic shock from `r length(unique(wdt$hosp))` hospitals in 4 European countries. We excluded 9 patients (6 missing data on their initial noradrenaline requirement, and three with a length of stay less than 24 hours). Each hospital contributing a median of `r hosp.n$q50` patients (IQR `r hosp.n$iqr`).

The subgroup of patients with resistant septic shock included `r grp.ne24$n[2]` (`r grp.ne24$n[2]`) patients who had not been weaned from noradrenaline within 24 hours. Within this, the tachycardic-shocked subgroup included `r grp.morelli$n[2]` (`r grp.morelli$p[2]`) patients with a heart rate greater than 95 beats/minute without preceding beta-blocker treatment. 

## Patient characteristics

```{r patients, include=FALSE, echo=FALSE}
# source(file="../analysis/table1_all.R")
(lac24 <- ff.mediqr(lac.24,dp=1))
ff.np
(lac24gt2 <- ff.np(var=lac24gt2, data=wdt[,.(lac24gt2=ifelse(lac.24>2 & !is.na(lac.24),1,0))], dp=0)) 
```
<!-- see Table 1 -->

Vasopressor support for septic shock commenced on the first ICU day for 311 (75%) patients --- the remaining patients developing septic shock during their critical care stay. Pneumonia was the commonest cause of infection (223 patients, 46%). The median SOFA score at 24 hours was 10 (IQR 8 to 12), and lactate at 24 hours was `r lac24$q50` mmol/l (IQR `r lac24$iqr`) with `r lac24gt2$n[2]` (`r lac24gt2$p[2]`) patients have a lactate greater than 2 mmol/l. The majority of patients (424, 87%) were mechanically ventilated, and 140 (29%) had already started renal replacement therapy (RRT) at 24 hours. The overall ICU and hospital mortalities were 41% (198 deaths), and 48% (233 deaths) respectively. 


## Variation in practice between sites

- [ ] TODO(2016-03-10): remove patient physiology, report treatment only except blood pressure which you can consider a target; therefore add in sedation and vadi
- [ ] TODO(2016-03-15): add in a test for trend?

We plotted the distribution of key haemodynamic parameters using separate box and whisker plots for each critical care unit. We ordered the plots by ther mean ICU mortality for the each hospital (Figure 1). Inspection of these showed that mean arterial pressure and noradrenaline doses were higher in units that had higher mean mortalities. Conversely, first 24 hour fluid balances were higher in units with lower mortalities. 

<!-- risk: ecological fallacy -->

<!-- notes:

Now model this

- treatment variables in 1st 24 hours
	+ fluid balance
	+ sedation
	+ noradrenaline use
	+ target blood pressure

- adjust for
	- baseline severity of illness at admission
	- age
	- sex
	- admission diagnosis
	- sepsis by body system
	- control for current
		+ steroid use
		+ other vasopressors
- report variability
	+ site vs residual: how much is accounted for unit level practice

 -->

## Predictors of 24 hour treatment variables

Discuss model output for 
- ne.24
- fb.24
- map.24

## Variation in mortality between sites

- [ ] TODO(2016-03-10): compare mortality to that reported in JAMA paper
- [ ] TODO(2016-03-10): report intersite variation in mortailty
- [ ] TODO(2016-03-10): look for heart rate mortality interaction





# Discussion points

- [ ] report patients meeting criteria for septic shock as per Sepsis 3
	- blood pressure or norad (all)
	- lactate > 2
